# Migration Map: Hexagonal Architecture ‚Üí Component-Based Architecture

## Overview

This document maps the migration from the current hexagonal architecture to the new component-based architecture for the Smart Irrigation System.

**Migration Strategy:** Incremental migration - new architecture in `components_new/` directory

**Date Updated:** 2025-10-03
**Version:** From v1.1.0 (Hexagonal) ‚Üí v2.0.0 (Component-Based)

---

## üî¥ MIGRATION PRINCIPLE

### **MIGRATE EXISTING FIRST, NEW FEATURES SECOND**

**Current Status**: Only `sensor_reader` component migrated

**Critical Rule**:
‚úÖ Complete migration of ALL existing components BEFORE implementing new features
‚ùå DO NOT implement `irrigation_controller` or `system_monitor` until migration is complete

**Rationale**:
1. Validates component-based architecture with proven code
2. Isolates migration issues from new feature bugs
3. Maintains `components/` as working fallback
4. Enables incremental testing and validation

---

## Architecture Comparison

### Before: Hexagonal Architecture (3 Layers)
```
components/
‚îú‚îÄ‚îÄ domain/              # Pure business logic (8 files)
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ value_objects/
‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îú‚îÄ‚îÄ application/         # Use cases (2 files)
‚îÇ   ‚îú‚îÄ‚îÄ use_cases/
‚îÇ   ‚îú‚îÄ‚îÄ dtos/
‚îÇ   ‚îî‚îÄ‚îÄ ports/
‚îî‚îÄ‚îÄ infrastructure/      # Adapters & drivers (33 files)
    ‚îú‚îÄ‚îÄ adapters/
    ‚îÇ   ‚îú‚îÄ‚îÄ wifi_adapter/
    ‚îÇ   ‚îú‚îÄ‚îÄ mqtt_adapter/
    ‚îÇ   ‚îî‚îÄ‚îÄ http_adapter/
    ‚îî‚îÄ‚îÄ drivers/
        ‚îî‚îÄ‚îÄ dht_sensor/
```

**Issues:**
- Excessive abstraction for embedded systems
- 43 total source files with complex dependencies
- Memory overhead from abstraction layers
- Difficult to navigate for ESP32 development

### After: Component-Based Architecture (7 Components)
```
components_new/
‚îú‚îÄ‚îÄ wifi_manager/        # WiFi connectivity (1-2 files)
‚îú‚îÄ‚îÄ mqtt_client/         # MQTT communication (1 file)
‚îú‚îÄ‚îÄ sensor_reader/       # All sensors unified (3 files)
‚îú‚îÄ‚îÄ irrigation_controller/ # NEW - irrigation logic (3 files)
‚îú‚îÄ‚îÄ device_config/       # Configuration management (1 file)
‚îú‚îÄ‚îÄ system_monitor/      # NEW - health monitoring (1 file)
‚îî‚îÄ‚îÄ http_server/         # HTTP REST API (1 file)
```

**Benefits:**
- Direct dependencies, minimal abstraction
- ~15 total source files (65% reduction)
- Single Responsibility per component
- ESP32-optimized architecture

---

## Component Migration Matrix

| Prioridad | Old (Hexagonal) | New (Component-Based) | Files to Migrate | Status |
|-----------|-----------------|----------------------|------------------|--------|
| **COMPLETADO** | `infrastructure/drivers/dht_sensor/` + soil drivers | `sensor_reader/` | dht_sensor.c + moisture drivers | ‚úÖ Migrado |
| üî¥ **Paso 1** | `infrastructure/adapters/wifi_adapter/` | `wifi_manager/` | wifi_adapter.c, wifi_connection_manager.c, wifi_prov_manager.c, boot_counter.c | ‚è≥ Pendiente |
| üî¥ **Paso 2** | `infrastructure/adapters/mqtt_adapter/` + `application/use_cases/publish_sensor_data.c` | `mqtt_client/` | mqtt_adapter.c, mqtt_client_manager.c, publish_sensor_data.c | ‚è≥ Pendiente |
| üü° **Paso 3** | `infrastructure/adapters/http_adapter/` | `http_server/` | http_adapter.c, server.c, endpoints/*.c | ‚è≥ Pendiente |
| üü° **Paso 4** | `domain/services/device_config_service.c` | `device_config/` | device_config_service.c | ‚è≥ Pendiente |
| üî¥ **Paso 5** | `main/iot-soc-smart-irrigation.c` | Actualizar a components_new/ | main.c | ‚è≥ Pendiente |
| **DESPU√âS** | **NEW** - Funcionalidad NUEVA | `irrigation_controller/` | **NEW implementation** con Logica_de_riego.md | ‚ùå NO Iniciado |
| **DESPU√âS** | **NEW** - Funcionalidad NUEVA | `system_monitor/` | **NEW implementation** | ‚ùå NO Iniciado |
| Integrar | `infrastructure/adapters/json_device_serializer.c` | Integrar en `mqtt_client/` y `http_server/` | json_device_serializer.c | ‚è≥ Pendiente |
| Eliminar | `infrastructure/adapters/shared_resource_manager.c` | Usar sem√°foros directos | shared_resource_manager.c | ‚è≥ Pendiente |

---

## Detailed Component Migration Plans

### 1. wifi_manager Component

**Source Files (Hexagonal):**
```
infrastructure/adapters/wifi_adapter/
‚îú‚îÄ‚îÄ src/wifi_adapter.c              ‚Üí wifi_manager.c (core logic)
‚îú‚îÄ‚îÄ src/wifi_connection_manager.c   ‚Üí wifi_manager.c (merge reconnection)
‚îú‚îÄ‚îÄ src/wifi_prov_manager.c         ‚Üí wifi_manager.c (merge provisioning)
‚îú‚îÄ‚îÄ src/boot_counter.c              ‚Üí wifi_manager.c (merge boot detection)
‚îî‚îÄ‚îÄ include/wifi_adapter.h          ‚Üí DELETE (replaced by wifi_manager.h)
```

**Migration Steps:**
1. ‚úÖ Create `wifi_manager.h` with simplified API
2. ‚úÖ Create `CMakeLists.txt` with dependencies
3. ‚è≥ Create `wifi_manager.c` merging all 4 source files
4. ‚è≥ Remove abstraction layers (direct WiFi stack calls)
5. ‚è≥ Keep provisioning mode for rural deployment
6. ‚è≥ Implement exponential backoff reconnection

**Key Changes:**
- Consolidate 4 files ‚Üí 1 file
- Remove adapter pattern abstraction
- Keep: Provisioning, reconnection, NVS credentials
- Remove: Unnecessary event forwarding layers

---

### 2. mqtt_client Component

**Source Files (Hexagonal):**
```
infrastructure/adapters/mqtt_adapter/
‚îú‚îÄ‚îÄ src/mqtt_adapter.c              ‚Üí mqtt_client.c (core)
‚îú‚îÄ‚îÄ src/mqtt_client_manager.c       ‚Üí mqtt_client.c (merge)
‚îî‚îÄ‚îÄ include/mqtt_adapter.h          ‚Üí DELETE

application/use_cases/
‚îî‚îÄ‚îÄ publish_sensor_data.c           ‚Üí mqtt_client.c (merge publishing logic)

infrastructure/adapters/
‚îî‚îÄ‚îÄ json_device_serializer.c        ‚Üí mqtt_client.c (merge JSON serialization)
```

**Migration Steps:**
1. ‚úÖ Create `mqtt_client.h` with unified API
2. ‚úÖ Create `CMakeLists.txt`
3. ‚è≥ Create `mqtt_client.c` merging 4 source files
4. ‚è≥ Integrate JSON serialization directly (no separate component)
5. ‚è≥ Implement device registration publishing
6. ‚è≥ Implement sensor data publishing
7. ‚è≥ Implement irrigation command subscription

**Key Changes:**
- Consolidate 4 files ‚Üí 1 file
- Merge use case logic into component
- Direct JSON formatting (cJSON library)
- Keep: WebSocket support, QoS 1, auto-reconnect

---

### 3. sensor_reader Component

**Source Files (Hexagonal):**
```
infrastructure/drivers/dht_sensor/
‚îî‚îÄ‚îÄ src/dht_sensor.c                ‚Üí sensor_reader/dht22_driver.c

domain/value_objects/
‚îú‚îÄ‚îÄ ambient_sensor_data.h           ‚Üí DELETE (replaced by common_types.h)
‚îî‚îÄ‚îÄ soil_sensor_data.h              ‚Üí DELETE (replaced by common_types.h)

EXTERNAL (to import):
‚îú‚îÄ‚îÄ soil_adc_driver.c               ‚Üí sensor_reader/soil_adc_driver.c (IMPORT)
‚îî‚îÄ‚îÄ soil_calibration.c              ‚Üí sensor_reader/soil_adc_driver.c (IMPORT)
```

**Migration Steps:**
1. ‚úÖ Create `sensor_reader.h` with unified sensor API
2. ‚úÖ Create `CMakeLists.txt` with ADC dependencies
3. ‚è≥ Migrate `dht_sensor.c` ‚Üí `dht22_driver.c`
4. ‚è≥ **IMPORT external soil sensor drivers** (see EXTERNAL_DRIVERS.md)
5. ‚è≥ Create `sensor_reader.c` orchestrating both sensor types
6. ‚è≥ Implement filtering and validation logic
7. ‚è≥ Implement health monitoring per sensor

**Key Changes:**
- Unified interface for all sensors
- Direct ADC usage for soil sensors
- Remove value objects (use common_types.h)
- Add calibration management

**External Dependencies:**
- DHT22 driver: Already implemented ‚úÖ
- Soil ADC driver: **NEEDS IMPORT** ‚ö†Ô∏è

---

### 4. irrigation_controller Component (NEW)

**Source Files:**
- **NO MIGRATION** - Completely new implementation

**Logic Sources:**
```
docs/
‚îú‚îÄ‚îÄ Logica_de_riego.md              ‚Üí Business rules source
‚îî‚îÄ‚îÄ CLAUDE.md                       ‚Üí GPIO configuration
```

**Implementation Files:**
```
irrigation_controller/
‚îú‚îÄ‚îÄ irrigation_controller.c         ‚Üí Main control logic
‚îú‚îÄ‚îÄ valve_driver.c                  ‚Üí GPIO relay control
‚îî‚îÄ‚îÄ safety_logic.c                  ‚Üí Safety interlocks
```

**Implementation Steps:**
1. ‚úÖ Create `irrigation_controller.h` with complete API
2. ‚úÖ Create `CMakeLists.txt`
3. ‚è≥ Implement `valve_driver.c`:
   - GPIO 21, 22 for relay control
   - Active HIGH relay control
   - Valve state tracking
4. ‚è≥ Implement `safety_logic.c`:
   - 2h max session duration
   - 4h minimum interval between sessions
   - Thermal protection (>40¬∞C auto-stop)
   - Over-irrigation protection (>80% auto-stop)
5. ‚è≥ Implement `irrigation_controller.c`:
   - Decision logic (Colombian dataset thresholds)
   - Online mode: MQTT command execution
   - Offline mode: 4-level adaptive irrigation
   - Session management and statistics

**Key Features:**
- **Thresholds:** 30% critical, 75% optimal, 80% max
- **Safety:** Thermal protection, duration limits, interval enforcement
- **Offline Modes:** Normal (2h), Warning (1h), Critical (30min), Emergency (15min)
- **Statistics:** Session history, runtime tracking

---

### 5. device_config Component

**Source Files (Hexagonal):**
```
domain/services/
‚îú‚îÄ‚îÄ device_config_service.c         ‚Üí device_config.c
‚îî‚îÄ‚îÄ device_config_service.h         ‚Üí DELETE (replaced)
```

**Migration Steps:**
1. ‚úÖ Create `device_config.h` with NVS API
2. ‚úÖ Create `CMakeLists.txt`
3. ‚è≥ Migrate `device_config_service.c` ‚Üí `device_config.c`
4. ‚è≥ Simplify API (remove domain service abstraction)
5. ‚è≥ Add configuration categories (wifi, mqtt, irrigation, sensors)
6. ‚è≥ Implement factory reset functionality

**Key Changes:**
- Remove domain service abstraction
- Direct NVS operations
- Centralized configuration management
- Category-based save/load

---

### 6. system_monitor Component (NEW)

**Source Files:**
- **NO MIGRATION** - Completely new implementation

**Implementation Files:**
```
system_monitor/
‚îî‚îÄ‚îÄ system_monitor.c                ‚Üí Complete monitoring logic
```

**Implementation Steps:**
1. ‚úÖ Create `system_monitor.h` with health check API
2. ‚úÖ Create `CMakeLists.txt`
3. ‚è≥ Implement component health checks:
   - WiFi manager status
   - MQTT client status
   - Sensor reader status
   - Irrigation controller status
4. ‚è≥ Implement connectivity monitoring:
   - WiFi connection state
   - MQTT connection state
   - Combined connectivity status
5. ‚è≥ Implement memory monitoring:
   - Free heap tracking
   - Minimum heap tracking
   - Memory warnings/alerts
6. ‚è≥ Implement event logging:
   - Component events
   - System events
   - Circular buffer for last 20 events

**Key Features:**
- Periodic health checks (60s interval)
- Memory monitoring (30s interval)
- Auto-recovery on component failures
- Event log for diagnostics

---

### 7. http_server Component

**Source Files (Hexagonal):**
```
infrastructure/adapters/http_adapter/
‚îú‚îÄ‚îÄ src/http_adapter.c              ‚Üí http_server.c (merge all)
‚îú‚îÄ‚îÄ src/http/server.c               ‚Üí http_server.c (merge)
‚îú‚îÄ‚îÄ src/http/endpoints/whoami.c     ‚Üí http_server.c (merge)
‚îú‚îÄ‚îÄ src/http/endpoints/temperature_humidity.c ‚Üí http_server.c (merge)
‚îú‚îÄ‚îÄ src/http/endpoints/ping.c       ‚Üí http_server.c (merge)
‚îú‚îÄ‚îÄ src/http/middleware/logging_middleware.c ‚Üí http_server.c (simple logging)
‚îî‚îÄ‚îÄ src/http/middleware/middleware_manager.c ‚Üí REMOVE (not needed)

infrastructure/adapters/
‚îî‚îÄ‚îÄ json_device_serializer.c        ‚Üí http_server.c (merge)
```

**Migration Steps:**
1. ‚úÖ Create `http_server.h` with endpoint definitions
2. ‚úÖ Create `CMakeLists.txt`
3. ‚è≥ Create `http_server.c` merging all endpoints
4. ‚è≥ Implement endpoints:
   - `/whoami` - Device info
   - `/sensors` - Current readings
   - `/ping` - Health check
   - `/status` - System status
   - `/irrigation` - Irrigation status
   - `/config` - Device configuration
5. ‚è≥ Remove middleware abstraction (direct logging)
6. ‚è≥ Add CORS headers for web clients

**Key Changes:**
- Consolidate 7 files ‚Üí 1 file
- Remove middleware pattern (overkill for ESP32)
- Direct endpoint handlers
- Keep: JSON responses, request logging

---

## Domain Layer Removal

**Files to Remove (No Migration):**

```
domain/
‚îú‚îÄ‚îÄ entities/                       ‚Üí REMOVE (not needed)
‚îÇ   ‚îú‚îÄ‚îÄ sensor.h
‚îÇ   ‚îú‚îÄ‚îÄ irrigation.h
‚îÇ   ‚îî‚îÄ‚îÄ device.h
‚îú‚îÄ‚îÄ value_objects/                  ‚Üí REPLACE with common_types.h
‚îÇ   ‚îú‚îÄ‚îÄ ambient_sensor_data.h
‚îÇ   ‚îú‚îÄ‚îÄ soil_sensor_data.h
‚îÇ   ‚îú‚îÄ‚îÄ complete_sensor_data.h
‚îÇ   ‚îú‚îÄ‚îÄ device_info.h
‚îÇ   ‚îî‚îÄ‚îÄ device_registration_message.h
‚îú‚îÄ‚îÄ repositories/                   ‚Üí REMOVE (direct NVS access)
‚îî‚îÄ‚îÄ services/                       ‚Üí MIGRATE to components
    ‚îú‚îÄ‚îÄ irrigation_logic.h          ‚Üí irrigation_controller component
    ‚îú‚îÄ‚îÄ sensor_manager.h            ‚Üí sensor_reader component
    ‚îî‚îÄ‚îÄ device_config_service.h     ‚Üí device_config component
```

**Rationale:**
- Value objects ‚Üí Replaced by `common_types.h` (single source of truth)
- Entities ‚Üí Not needed (direct structs in common_types.h)
- Repositories ‚Üí Overkill (direct NVS operations in components)
- Services ‚Üí Business logic moved to respective components

---

## Application Layer Removal

**Files to Remove/Migrate:**

```
application/
‚îú‚îÄ‚îÄ use_cases/
‚îÇ   ‚îî‚îÄ‚îÄ publish_sensor_data.c       ‚Üí MIGRATE to mqtt_client component
‚îú‚îÄ‚îÄ dtos/                           ‚Üí REMOVE (use common_types.h)
‚îî‚îÄ‚îÄ ports/                          ‚Üí REMOVE (direct dependencies)
```

**Rationale:**
- Use cases ‚Üí Integrated into components (no separate layer)
- DTOs ‚Üí Not needed (use common types directly)
- Ports ‚Üí Component-based uses direct dependencies

---

## Shared Utilities Handling

### JSON Serialization
**Old:** `infrastructure/adapters/json_device_serializer.c`
**New:** Integrated into `mqtt_client` and `http_server` components

**Why:** JSON formatting is simple enough to embed directly in components that use it

### Resource Management
**Old:** `infrastructure/adapters/shared_resource_manager.c`
**New:** Direct semaphore usage in components that need synchronization

**Why:** Abstraction adds complexity without value for ESP32

---

## Data Flow Changes

### Before (Hexagonal):
```
main.c ‚Üí Use Case ‚Üí Domain Service ‚Üí Repository Interface ‚Üí Adapter ‚Üí ESP-IDF
```

### After (Component-Based):
```
main.c ‚Üí Component ‚Üí ESP-IDF
```

**Example Flow: Sensor Reading + Publishing**

**Before:**
```
sensor_publishing_task()
  ‚Üí publish_sensor_data_use_case()
    ‚Üí sensor_manager_read() [domain service]
      ‚Üí dht_sensor_read() [infrastructure driver]
    ‚Üí json_device_serializer_serialize() [infrastructure adapter]
    ‚Üí mqtt_adapter_publish() [infrastructure adapter]
      ‚Üí mqtt_client_manager_publish() [infrastructure internal]
```

**After:**
```
sensor_publishing_task()
  ‚Üí sensor_reader_get_all()  [direct component call]
  ‚Üí mqtt_client_publish_sensor_data()  [direct component call]
```

**Result:** 7 function calls ‚Üí 2 function calls

---

## New main.c Structure

```c
// main/main.c - Component-Based
#include "wifi_manager.h"
#include "mqtt_client.h"
#include "sensor_reader.h"
#include "irrigation_controller.h"
#include "device_config.h"
#include "system_monitor.h"
#include "http_server.h"

void app_main(void) {
    // 1. Initialize base system
    nvs_flash_init();
    esp_event_loop_create_default();

    // 2. Initialize components
    device_config_init();
    sensor_reader_init(NULL);
    irrigation_controller_init(NULL);
    wifi_manager_init();
    mqtt_client_init();
    http_server_init(NULL);
    system_monitor_init(NULL);

    // 3. Start components
    wifi_manager_start();
    mqtt_client_start();
    http_server_start();
    system_monitor_start();

    // 4. Create application tasks
    xTaskCreate(sensor_reading_task, "sensor", 4096, NULL, 5, NULL);
    xTaskCreate(irrigation_task, "irrigation", 4096, NULL, 4, NULL);

    ESP_LOGI(TAG, "System ready");
}

// Sensor reading task (direct calls)
void sensor_reading_task(void* params) {
    sensor_reading_t reading;
    while (1) {
        sensor_reader_get_all(&reading);
        mqtt_client_publish_sensor_data(&reading);
        irrigation_controller_evaluate_and_act(&reading.soil, &reading.ambient, NULL);
        vTaskDelay(pdMS_TO_TICKS(60000)); // 60s
    }
}
```

**Key Differences:**
- Direct component initialization (no adapters)
- Simplified task implementation
- Clear data flow: sensor ‚Üí mqtt + irrigation

---

## Memory Impact Analysis

### Before (Hexagonal):
- **Total Files:** 43 source files
- **Memory Overhead:** ~30KB from abstraction layers
- **Stack Usage:** Multiple function call overhead
- **Heap Usage:** Dynamic allocation in adapters

### After (Component-Based):
- **Total Files:** ~15 source files (65% reduction)
- **Memory Overhead:** ~5KB (direct calls)
- **Stack Usage:** Reduced call depth
- **Heap Usage:** Static allocation preferred

**Expected Savings:** ~25KB RAM, ~30KB Flash

---

## Testing Strategy

### Phase 1: Individual Component Testing
1. Test each component in isolation
2. Mock dependencies as needed
3. Verify component health checks

### Phase 2: Integration Testing
1. Test component interactions (sensor ‚Üí mqtt)
2. Test offline mode transitions
3. Test safety interlocks

### Phase 3: System Testing
1. Full system integration
2. Long-term stability testing
3. Power consumption validation

---

## Migration Checklist

### ‚úÖ Preparaci√≥n (COMPLETADO)
- [x] Create `components_new/` structure
- [x] Create all component headers (.h files)
- [x] Create all CMakeLists.txt files
- [x] Create common_types.h
- [x] Implement sensor_reader.c (+ moisture sensor drivers)

### üî¥ FASE 1: Migrar Componentes Existentes (CR√çTICO - EN PROGRESO)
- [ ] **Paso 1**: Implement wifi_manager.c
- [ ] **Paso 2**: Implement mqtt_client.c
- [ ] **Paso 3**: Implement http_server.c
- [ ] **Paso 4**: Implement device_config.c
- [ ] **Paso 5**: Update main.c to use components_new/ exclusively
- [ ] **Paso 6**: Test compilation (sistema completo compila)
- [ ] **Paso 7**: Validate on hardware (WiFi + MQTT + HTTP functional)

### üü° FASE 2: Nuevas Funcionalidades (DESPU√âS DE FASE 1)
- [ ] Implement irrigation_controller.c (NUEVO - no migraci√≥n)
- [ ] Implement system_monitor.c (NUEVO - no migraci√≥n)
- [ ] Test offline irrigation logic
- [ ] Test safety interlocks

### üü¢ FASE 3: Limpieza Final
- [ ] Performance validation (memoria, estabilidad)
- [ ] Remove old `components/` directory (solo despu√©s de validar todo)
- [ ] Update root CMakeLists.txt (final cleanup)

---

## Timeline Estimate (ACTUALIZADO)

| Phase | Task | Duration | Status |
|-------|------|----------|--------|
| Prep | Structure & Headers + sensor_reader | 3 hours | ‚úÖ COMPLETADO |
| **FASE 1** | **Migraci√≥n Componentes Existentes** | **8-12 horas** | **‚è≥ PENDIENTE** |
| 1.1 | wifi_manager migration | 2-3 hours | ‚è≥ Pendiente |
| 1.2 | mqtt_client migration | 2-3 hours | ‚è≥ Pendiente |
| 1.3 | http_server migration | 2-3 hours | ‚è≥ Pendiente |
| 1.4 | device_config migration | 1 hour | ‚è≥ Pendiente |
| 1.5 | main.c update + compilation | 1-2 hours | ‚è≥ Pendiente |
| 1.6 | Hardware validation | 2 hours | ‚è≥ Pendiente |
| **FASE 2** | **Nuevas Funcionalidades** | **12-16 horas** | **‚ùå NO INICIADO** |
| 2.1 | irrigation_controller (NEW) | 6-8 hours | ‚ùå NO Iniciado |
| 2.2 | system_monitor (NEW) | 3-4 hours | ‚ùå NO Iniciado |
| 2.3 | Testing & validation | 3-4 hours | ‚ùå NO Iniciado |
| **FASE 3** | **Cleanup & Optimization** | **2-4 horas** | **‚ùå NO INICIADO** |
| **Total** | | **~30 hours** | **10% completado** |

---

## Risk Mitigation

**Risks:**
1. Sensor driver compatibility issues
2. MQTT WebSocket connection stability
3. Memory constraints during transition

**Mitigation:**
1. Test drivers individually before integration
2. Keep original code until new architecture proven stable
3. Monitor memory usage at each migration step
4. Maintain `components/` directory until full validation

---

## Success Criteria

### ‚úÖ FASE 1 - Migraci√≥n Componentes Existentes (CR√çTICO)

**Criterio de √âxito**: Sistema funciona IGUAL que arquitectura hexagonal

- [ ] Todos los componentes existentes migrados (wifi, mqtt, http, config)
- [ ] Sistema compila sin errores
- [ ] WiFi provisioning funcional en hardware
- [ ] MQTT publishing funcional en hardware
- [ ] HTTP endpoints respondiendo en hardware
- [ ] Memoria usage <200KB RAM, <1MB Flash
- [ ] Sistema estable 24+ horas
- [ ] No regressions vs arquitectura hexagonal

### üü° FASE 2 - Nuevas Funcionalidades (DESPU√âS)

**Criterio de √âxito**: Features nuevas implementadas y funcionando

- [ ] irrigation_controller implementado y probado
- [ ] system_monitor implementado y probado
- [ ] L√≥gica de riego offline funcional (4 modos)
- [ ] Safety interlocks validados
- [ ] Calibraci√≥n din√°mica de sensores funcional

### üü¢ FASE 3 - Limpieza Final

- [ ] Arquitectura limpia, components/ removido
- [ ] Documentaci√≥n actualizada
- [ ] Performance validated
- [ ] Ready for production

---

## Post-Migration Improvements - DHT22 Driver Optimization

### Overview

The DHT22 driver has been migrated with **NIVEL 1** improvements (wrapper + retry logic) implemented. This section documents planned improvements for **NIVEL 2-4** to be executed after the complete component-based migration is stable.

**Current Implementation Status:**
- ‚úÖ **NIVEL 1 COMPLETED:** `dht_read_ambient_data()` wrapper with automatic retry (3 attempts, 2.5s backoff)
- ‚è≥ **NIVEL 2-4:** Planned for post-migration optimization

---

### Phase 1: NIVEL 2 - Production Readiness (HIGH PRIORITY) üî¥

**When to Execute:**
- Trigger: Component migration completed and tested
- Trigger: First field deployment scheduled
- Trigger: Rural connectivity issues observed in testing

**Duration:** 3 hours
**Impact:** üî¥ **CRITICAL** - Essential for reliable field operation

#### 2.1 Intelligent Throttling & Cache System
**Problem:** DHT22 requires minimum 2s between reads, rapid calls cause sensor lockup
**Expected Impact:** Prevents 90% of timing errors, reduces power consumption

#### 2.2 Range Validation
**Problem:** Corrupted readings can pass checksum but contain impossible values
**Expected Impact:** Eliminates 100% of out-of-range readings affecting irrigation decisions

---

### Phase 2: NIVEL 3 - Field Optimization (MEDIUM PRIORITY) üü°

**When to Execute:**
- After 1 week of production data
- Retry statistics show optimization opportunities

**Duration:** 2 hours
**Impact:** üü° **MEDIUM** - Enables remote tuning and diagnostics

#### 3.1 Dynamic Configuration
**Problem:** Different field conditions need different retry strategies
**Expected Impact:** 30% reduction in false errors via field-specific tuning

#### 3.2 Enhanced Diagnostic Logging
**Problem:** Remote troubleshooting is difficult without detailed timing data
**Expected Impact:** 60% reduction in field debugging time

---

### Phase 3: NIVEL 4 - Advanced Monitoring (LOW PRIORITY) üü¢

**When to Execute:**
- After 1 month production operation
- Predictive maintenance program initiated

**Duration:** 2 hours
**Impact:** üü¢ **LOW** - Predictive maintenance capabilities

#### 4.1 Health Statistics API
**Features:** Track success rates, detect failing sensors before complete failure
**Expected Impact:** 2-7 days advance warning of sensor failures

---

## Implementation Timeline

| Phase | Priority | Duration | Cumulative | Trigger |
|-------|----------|----------|------------|---------|
| NIVEL 1 | üî¥ CRITICAL | 2h | 2h | Before migration ‚úÖ |
| NIVEL 2 | üî¥ HIGH | 3h | 5h | Pre-deployment |
| NIVEL 3 | üü° MEDIUM | 2h | 7h | After 1 week |
| NIVEL 4 | üü¢ LOW | 2h | 9h | After 1 month |

See `EXTERNAL_DRIVERS.md` section "DHT22 Driver Improvement Roadmap" for detailed technical implementation.

---

**Next Document:** See `EXTERNAL_DRIVERS.md` for drivers to import from external repositories.
